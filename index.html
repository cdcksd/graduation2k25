<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Graduation Post Generator — Mobile Friendly</title>

  <!-- Cropper.js CSS -->
  <link href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>

  <style>
    /* --- Fonts & colors --- */
    @font-face {
      font-family: 'Futura';
      src: url('./Futura.ttf') format('truetype');
      font-display: swap;
    }
    :root{
      --primary: #021349;
      --card-bg: #fff;
      --ui-radius: 10px;
      --gutter: 12px;
    }

    /* --- Page layout --- */
    html,body{height:100%;margin:0;}
    body{
      font-family: Arial, sans-serif;
      background:#f0f2f5;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:20px;
      box-sizing:border-box;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .wrap{
      width:100%;
      max-width:980px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:20px;
      align-items:start;
    }

    /* Column for controls */
    .panel{
      background:var(--card-bg);
      border-radius:var(--ui-radius);
      padding:14px;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
      box-sizing:border-box;
    }
    .panel h2{margin:0 0 10px 0;font-size:18px}
    .field{margin:8px 0}
    input[type="text"], input[type="file"]{
      width:100%; padding:9px; border-radius:8px; border:1px solid #d6d6d6; box-sizing:border-box;
      font-size:15px;
    }
    .toggle-container{display:flex; gap:8px; margin-bottom:8px}
    .toggle-btn{
      flex:1; padding:8px; border-radius:8px; border:1px solid #d6d6d6; background:#f6f6f6; cursor:pointer;
      font-size:13px;
    }
    .toggle-btn.active{ background:var(--primary); color:#fff; border-color:var(--primary) }

    .panel button.primary{
      width:100%; padding:12px; border-radius:8px; background:var(--primary); color:#fff; border:none;
      font-weight:700; cursor:pointer;
    }
    .hint{font-size:13px;color:#666;margin-top:8px;text-align:center}

    /* Card preview column */
    .preview-panel{
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
      padding:6px;
    }

    /* Canvas: internal resolution fixed, visual size responsive */
    #cardCanvas{
      width:100%;
      max-width:540px; /* preview max width */
      height:auto;
      border-radius:10px;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
      background:var(--card-bg);
      display:block;
    }

    /* download row */
    .row{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; width:100%}
    .small{font-size:12px;color:#666}

    /* --- Crop modal (mobile-first full-screen) --- */
    #cropModal{
      display:none; position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,0.85);
      align-items:center; justify-content:center;
    }
    #cropModal.visible{ display:flex; }
    .modal-panel{
      width:100%; height:100%; background:#fff; display:flex; flex-direction:column;
      box-sizing:border-box;
    }
    #cropperImage{
      flex:1; width:100%; height:100%; object-fit:contain; touch-action:none; /* let cropper handle gestures */
    }
    .modal-controls{
      display:flex; gap:10px; padding:12px; box-sizing:border-box;
      background:#fff; justify-content:space-between;
    }
    .modal-controls button{
      flex:1; padding:12px; border-radius:8px; font-weight:700; cursor:pointer; border:none;
      font-size:15px;
    }
    .modal-controls button.secondary{ background:#777; color:#fff; margin-left:8px; }
    .modal-controls button.primary{ background:var(--primary); color:#fff; }

    /* --- Desktop modal style override --- */
    @media(min-width:768px){
      .modal-panel{
        width:auto; height:auto; max-width:90vw; max-height:90vh; border-radius:12px; overflow:hidden;
      }
      #cropperImage{ max-width:calc(90vw - 40px); max-height:calc(80vh - 120px) }
      .modal-controls{ gap:12px; padding:10px; }
    }

    /* --- Responsive layout for smaller screens --- */
    @media(max-width:960px){
      .wrap{ grid-template-columns: 1fr; padding-bottom:40px; }
      .panel{ order:2; width:100% }
      .preview-panel{ order:1; padding-top:0 }
      #cardCanvas{ max-width:100%; }
    }

    /* small helper to make inputs stack nicely on tiny screens */
    @media(max-width:420px){
      .toggle-btn{ font-size:12px; padding:10px 6px }
      input[type="text"]{ font-size:14px; padding:8px }
      .modal-controls button{ padding:12px 8px; font-size:14px }
    }
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <!-- LEFT: Controls -->
    <div class="panel" aria-labelledby="generatorTitle">
      <h2 id="generatorTitle">Graduation Post Generator</h2>

      <div class="toggle-container" role="tablist" aria-label="Background templates">
        <button class="toggle-btn active" onclick="setBackground('art2.png', this)">DZ</button>
        <button class="toggle-btn" onclick="setBackground('art1.png', this)">CAD</button>
        <button class="toggle-btn" onclick="setBackground('art3.png', this)">SYN</button>
        <button class="toggle-btn" onclick="setBackground('art4.png', this)">LW</button>
      </div>

      <div class="field">
        <input id="name" type="text" placeholder="Course" aria-label="Full name">
      </div>
      <div class="field">
        <input id="course" type="text" placeholder="Full Name" aria-label="Course">
      </div>

      <div class="field">
        <input id="photoInput" type="file" accept="image/*" aria-label="Upload photo">
      </div>

      <div class="field">
        <button class="primary" id="downloadBtn" onclick="generateCard()">Download PNG</button>
      </div>

      <div class="hint">Upload a photo → Resize square crop → Crop & Save → Download. Works on touch devices.</div>
    </div>

    <!-- RIGHT: Preview -->
    <div class="preview-panel">
      <!-- Canvas internal resolution stays 1080x1538 to keep download quality -->
      <canvas id="cardCanvas" width="1080" height="1538" role="img" aria-label="Graduation card preview"></canvas>
      <div class="row">
        <div class="small">Preview above is scaled for screen — download gives full resolution.</div>
      </div>
    </div>
  </div>

  <!-- Crop modal -->
  <div id="cropModal" aria-hidden="true">
    <div class="modal-panel" role="dialog" aria-modal="true" aria-label="Crop photo dialog">
      <img id="cropperImage" alt="Crop preview" />
      <div class="modal-controls">
        <button id="cropSaveBtn" class="primary">Crop & Save</button>
        <button id="cropCancelBtn" class="secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Cropper.js -->
  <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>

  <script>
    // === State ===
    let uploadedPhoto = "";        // DataURL of cropped image (square)
    let backgroundImage = "art2.png";
    let nameFontColor = "#f23886";
    let courseFontColor = "#f9f0ea";
    const PHOTO_DRAW_SIZE = 860; // square size used on the card (drawn on 1080x1538 canvas)
    let cropper = null;

    // DOM refs
    const photoInput = document.getElementById('photoInput');
    const cropModal = document.getElementById('cropModal');
    const cropperImage = document.getElementById('cropperImage');
    const cropSaveBtn = document.getElementById('cropSaveBtn');
    const cropCancelBtn = document.getElementById('cropCancelBtn');
    const canvas = document.getElementById('cardCanvas');
    const ctx = canvas.getContext('2d');

    // Helper: load image as HTMLImageElement (crossOrigin set for safety)
    function loadImageAsync(src){
      return new Promise((resolve, reject)=>{
        if(!src) return resolve(null);
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = ()=>resolve(img);
        img.onerror = ()=>reject(new Error("Failed to load " + src));
        img.src = src;
      });
    }

    // Toggle backgrounds & responsive color changes
    function setBackground(file, btn){
      backgroundImage = file;
      document.querySelectorAll(".toggle-btn").forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');

      // apply color schemes per template
      if (file === "art1.png") { nameFontColor = "#423a39"; courseFontColor = "#e3e3e3"; }
      else if (file === "art3.png") { nameFontColor = "#3d6baf"; courseFontColor = "#e3e3e3"; }
      else if (file === "art4.png") { nameFontColor = "#423a39"; courseFontColor = "#e3e3e3"; }
      else { nameFontColor = "#f23886"; courseFontColor = "#f9f0ea"; }

      drawCard();
    }

    // Initialize cropper modal when user picks file
    photoInput.addEventListener('change', (ev)=>{
      const file = ev.target.files && ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e){
        cropperImage.src = e.target.result;
        // show modal
        cropModal.classList.add('visible');
        cropModal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';

        // cleanup previous cropper
        if (cropper){ try{ cropper.destroy(); } catch(e){} cropper = null; }

        cropperImage.onload = function(){
          // init Cropper.js tuned for mobile/touch
          cropper = new Cropper(cropperImage, {
            aspectRatio: 1,
            viewMode: 1,
            autoCropArea: 0.9,
            responsive: true,
            movable: true,
            zoomable: true,
            rotatable: false,
            scalable: false,
            dragMode: 'move',            // makes panning easier on touch
            cropBoxResizable: true,
            cropBoxMovable: true,
            background: false,
            guides: true,
            minCropBoxWidth: 60,
            minCropBoxHeight: 60,
            toggleDragModeOnDblclick: false
          });

          // attempt to set the crop box to as large as possible after layout stabilizes
          setTimeout(()=>{
            try{
              const container = cropper.getContainerData();
              const displayBox = Math.min(container.width, container.height) * 0.88;
              cropper.setCropBoxData({
                left: (container.width - displayBox)/2,
                top: (container.height - displayBox)/2,
                width: displayBox,
                height: displayBox
              });
            }catch(e){}
          }, 80);
        };
      };
      reader.readAsDataURL(file);
    });

    // Crop & Save -> export square canvas at PHOTO_DRAW_SIZE for good quality
    cropSaveBtn.addEventListener('click', async ()=>{
      if (!cropper) return;
      const croppedCanvas = cropper.getCroppedCanvas({
        width: PHOTO_DRAW_SIZE,
        height: PHOTO_DRAW_SIZE,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
      });
      uploadedPhoto = croppedCanvas.toDataURL('image/png');

      try{ cropper.destroy(); }catch(e){}
      cropper = null;
      cropModal.classList.remove('visible');
      cropModal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      photoInput.value = "";

      drawCard();
    });

    // Cancel cropping -> close modal, keep previous photo (if any)
    cropCancelBtn.addEventListener('click', ()=>{
      if (cropper) { try{ cropper.destroy(); }catch(e){} cropper = null; }
      cropModal.classList.remove('visible');
      cropModal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      photoInput.value = "";
    });

    // Clicking outside modal content closes it (mobile-friendly)
    cropModal.addEventListener('click', (e)=>{
      if (e.target === cropModal){
        if (cropper) { try{ cropper.destroy(); }catch(e){} cropper = null; }
        cropModal.classList.remove('visible');
        cropModal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        photoInput.value = "";
      }
    });

    // redraw when name/course typed
    document.getElementById('name').addEventListener('input', drawCard);
    document.getElementById('course').addEventListener('input', drawCard);

    // Compose final card on internal 1080x1538 canvas
    async function drawCard(){
      // try to load custom font (if present) but don't block
      try{ await document.fonts.load("60px Futura"); }catch(e){}

      // clear
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // draw background (if available)
      const bgImg = await loadImageAsync('./' + backgroundImage).catch(()=>null);
      if (bgImg) ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
      else { ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height); }

      // draw photo (cropped square) or fallback preview
      const photoSrc = uploadedPhoto || './previewImage.jfif';
      const photo = await loadImageAsync(photoSrc).catch(()=>null);

      const photoX = 113;
      const photoY = 312;
      const photoW = PHOTO_DRAW_SIZE;
      const photoH = PHOTO_DRAW_SIZE;

      if (photo){
        const tiltAngle = 0.02;
        ctx.save();
        ctx.translate(photoX + photoW/2, photoY + photoH/2);
        ctx.rotate(tiltAngle);
        ctx.drawImage(photo, -photoW/2, -photoH/2, photoW, photoH);
        ctx.restore();
      } else {
        // optional: draw placeholder box
        ctx.save();
        ctx.translate(photoX + photoW/2, photoY + photoH/2);
        ctx.rotate(0.02);
        ctx.fillStyle = '#f3f3f3';
        ctx.fillRect(-photoW/2, -photoH/2, photoW, photoH);
        ctx.restore();
      }

      // Name
      const name = document.getElementById('name').value || "";
      ctx.save();
      ctx.translate(145, 1262);
      ctx.rotate(0.02);
      ctx.fillStyle = nameFontColor;
      ctx.font = "bold 48px Futura, Arial";
      ctx.textBaseline = "alphabetic";
      ctx.fillText(name, 0, 0);
      ctx.restore();

      // Course
      const course = document.getElementById('course').value || "";
      ctx.save();
      ctx.translate(145, 1327);
      ctx.rotate(0.02);
      ctx.fillStyle = courseFontColor;
      ctx.font = "bold 32px Futura, Arial";
      ctx.fillText(course, 0, 0);
      ctx.restore();
    }

    // Generate PNG and trigger download
    function generateCard(){
      const nameVal = (document.getElementById('name').value || 'Graduation').trim() || 'Graduation';
      const filename = nameVal.replace(/\s+/g, '') + ".png";
      const link = document.createElement('a');
      link.download = filename;
      link.href = canvas.toDataURL('image/png');
      // some browsers require appending to DOM for click to work
      document.body.appendChild(link);
      link.click();
      link.remove();
    }

    // Initial draw
    drawCard();

    // Accessibility: keyboard escape closes modal
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && cropModal.classList.contains('visible')) {
        if (cropper) { try{ cropper.destroy(); }catch(e){} cropper = null; }
        cropModal.classList.remove('visible');
        cropModal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        photoInput.value = "";
      }
    });
  </script>
</body>
</html>
