<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Graduation Post Generator — Resizable 1:1 Crop</title>

  <!-- Cropper.js CDN -->
  <link href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>

  <style>
    @font-face {
      font-family: 'Futura';
      src: url('./Futura.ttf') format('truetype');
    }

    :root {
      --primary: #021349;
    }

    body {
      font-family: Arial, sans-serif;
      background: #eee;
      padding: 20px;
      margin: 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 32px;
    }

    .form-section {
      background: #fff;
      padding: 14px;
      border-radius: 10px;
      box-shadow: 2px 2px 12px rgba(0,0,0,0.08);
      width: 340px;
      box-sizing: border-box;
    }
    .form-section h2 { margin: 0 0 10px 0; font-size: 18px; }
    .form-section input[type="text"],
    .form-section input[type="file"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    .form-section button {
      width: 100%;
      padding: 9px;
      border: none;
      border-radius: 6px;
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    .toggle-container {
      display:flex;
      gap:6px;
      margin-bottom:8px;
    }
    .toggle-btn {
      flex:1;
      padding:8px;
      border-radius:6px;
      border:1px solid #ccc;
      background:#f6f6f6;
      cursor:pointer;
      font-size:13px;
    }
    .toggle-btn.active { background: var(--primary); color:#fff; border-color:var(--primary); }

    canvas { border:1px solid #ccc; background:#fff; display:block; }

    #cardCanvas {
      width: 270px; /* preview size */
      height: auto;
    }

    /* Modal cropper */
    #cropModal {
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.75);
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:20px;
    }
    #cropModal.visible { display:flex; }
    .modal-panel {
      background:#fff;
      border-radius:10px;
      padding:12px;
      max-width: 95vw;
      max-height: 90vh;
      width: auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      box-sizing:border-box;
      align-items:center;
    }
    #cropperImage {
      max-width: calc(90vw - 40px);
      max-height: calc(80vh - 160px);
      display:block;
    }
    .modal-controls {
      display:flex;
      gap:8px;
      justify-content:center;
      width:100%;
    }
    .modal-controls button {
      padding:8px 12px;
      border-radius:6px;
      border:none;
      cursor:pointer;
      background:var(--primary);
      color:#fff;
      font-weight:600;
    }
    .modal-controls button.secondary {
      background:#777;
    }

    /* small helper */
    .small { font-size:12px; color:#666; margin-top:6px; }
  </style>
</head>
<body>

  <div class="form-section">
    <h2>Graduation Post Generator</h2>

    <div class="toggle-container">
      <button class="toggle-btn active" onclick="setBackground('art2.png', this)">DZ</button>
      <button class="toggle-btn" onclick="setBackground('art1.png', this)">CAD</button>
      <button class="toggle-btn" onclick="setBackground('art3.png', this)">SYN</button>
      <button class="toggle-btn" onclick="setBackground('art4.png', this)">LW</button>
    </div>

    <input type="text" id="name" placeholder="Full Name" />
    <input type="text" id="course" placeholder="Course" />
    <input type="file" id="photoInput" accept="image/*" />
    <button id="downloadBtn" onclick="generateCard()">Download PNG</button>
    <div class="small">Upload a photo → resize the square crop (1:1) → Crop & Save → Download.</div>
  </div>

  <canvas id="cardCanvas" width="1080" height="1538"></canvas>

  <!-- Crop modal (uses <img> + Cropper.js) -->
  <div id="cropModal" aria-hidden="true">
    <div class="modal-panel" role="dialog" aria-modal="true">
      <img id="cropperImage" alt="Crop preview">
      <div class="modal-controls">
        <button id="cropSaveBtn">Crop & Save</button>
        <button id="cropCancelBtn" class="secondary">Cancel</button>
      </div>
      <div class="small">Crop box is locked to 1:1 but you can resize & move it. Use mouse or touch.</div>
    </div>
  </div>

  <!-- Cropper.js -->
  <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>

  <script>
    // === State ===
    let uploadedPhoto = "";        // DataURL of cropped image (square)
    let backgroundImage = "art2.png";
    let nameFontColor = "#f23886";
    let courseFontColor = "#f9f0ea";

    // Card photo target size (drawn on canvas)
    const PHOTO_DRAW_SIZE = 860; // square size used on the card

    // Cropper.js instance
    let cropper = null;

    // DOM
    const photoInput = document.getElementById('photoInput');
    const cropModal = document.getElementById('cropModal');
    const cropperImage = document.getElementById('cropperImage');
    const cropSaveBtn = document.getElementById('cropSaveBtn');
    const cropCancelBtn = document.getElementById('cropCancelBtn');

    // LOAD helpers
    function loadImageAsync(src) {
      return new Promise((resolve, reject) => {
        if (!src) return resolve(null);
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error("Failed to load image: " + src));
        img.src = src;
      });
    }

    // Background toggle logic (keeps previous colors)
    function setBackground(file, btn) {
      backgroundImage = file;
      document.querySelectorAll(".toggle-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      if (file === "art1.png") { // CAD
        nameFontColor = "#423a39";
        courseFontColor = "#e3e3e3";
      } else if (file === "art3.png") { // SYN
        nameFontColor = "#3d6baf";
        courseFontColor = "#e3e3e3";
      } else if (file === "art4.png") { // LW
        nameFontColor = "#423a39";
        courseFontColor = "#e3e3e3";
      } else {
        nameFontColor = "#f23886";
        courseFontColor = "#f9f0ea";
      }

      drawCard();
    }

    // When user selects a file -> show crop modal and init Cropper.js
    photoInput.addEventListener('change', (ev) => {
      const file = ev.target.files && ev.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        cropperImage.src = e.target.result; // DataURL of original image
        // Show modal
        cropModal.classList.add('visible');
        cropModal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';

        // destroy previous cropper if any
        if (cropper) {
          try { cropper.destroy(); } catch (err) { /* ignore */ }
          cropper = null;
        }

        // wait for image to be parsed in DOM then init cropper
        cropperImage.onload = function() {
          // init cropper with locked 1:1 aspect ratio and resizable crop box
          cropper = new Cropper(cropperImage, {
            aspectRatio: 1,
            viewMode: 1, // ensure image fits inside container
            autoCropArea: 0.6,
            responsive: true,
            movable: true,
            zoomable: true,
            rotatable: false,
            scalable: false,
            cropBoxResizable: true,
            cropBoxMovable: true,
            minCropBoxWidth: 50,
            minCropBoxHeight: 50,
            background: false,
            modal: true,
            guides: true
          });

          // optional: make crop box initially as large as possible while remaining square
          // we set it after a tiny delay so Cropper has computed sizes
          setTimeout(() => {
            try {
              const imgRect = cropper.getImageData();
              const boxSize = Math.min(imgRect.naturalWidth, imgRect.naturalHeight) * 0.8;
              // set crop box to centered square (in displayed pixels)
              const containerData = cropper.getContainerData();
              const displayBox = Math.min(containerData.width, containerData.height) * 0.8;
              cropper.setCropBoxData({
                left: (containerData.width - displayBox) / 2,
                top: (containerData.height - displayBox) / 2,
                width: displayBox,
                height: displayBox
              });
            } catch (e) { /* ignore if fails */ }
          }, 60);
        };
      };
      reader.readAsDataURL(file);
    });

    // Crop & Save -> get a square canvas (PHOTO_DRAW_SIZE x PHOTO_DRAW_SIZE) and store data URL
    cropSaveBtn.addEventListener('click', async () => {
      if (!cropper) return;

      // Export a square canvas sized to PHOTO_DRAW_SIZE for good quality
      const croppedCanvas = cropper.getCroppedCanvas({
        width: PHOTO_DRAW_SIZE,
        height: PHOTO_DRAW_SIZE,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
      });

      // Save as data URL and use it as uploadedPhoto
      uploadedPhoto = croppedCanvas.toDataURL('image/png');

      // Destroy cropper and hide modal
      try { cropper.destroy(); } catch (e) { /* ignore */ }
      cropper = null;
      cropModal.classList.remove('visible');
      cropModal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';

      // Draw card with new photo
      drawCard();
    });

    // Cancel cropping -> destroy and hide modal (do not change uploadedPhoto)
    cropCancelBtn.addEventListener('click', () => {
      if (cropper) {
        try { cropper.destroy(); } catch (e) { /* ignore */ }
        cropper = null;
      }
      cropModal.classList.remove('visible');
      cropModal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      // reset file input so user can re-upload same file later if needed
      photoInput.value = "";
    });

    // redraw when name/course typed
    document.getElementById('name').addEventListener('input', drawCard);
    document.getElementById('course').addEventListener('input', drawCard);

    // drawCard: compose final graduation card on a 1080x1538 canvas
    async function drawCard() {
      try {
        await document.fonts.load("60px Futura");
      } catch (e) {
        // ignore font load errors; fallback to default
      }

      const canvas = document.getElementById('cardCanvas');
      const ctx = canvas.getContext('2d');

      // Clear
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw background (if available)
      const bgImg = await loadImageAsync('./' + backgroundImage).catch(() => null);
      if (bgImg) {
        ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
      } else {
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      // Load the cropped photo (if exists) or fallback preview
      const photoSrc = uploadedPhoto || './previewImage.jfif';
      const photo = await loadImageAsync(photoSrc).catch(() => null);

      // Define where photo should be drawn on the card
      const photoX = 113;
      const photoY = 312;
      const photoW = PHOTO_DRAW_SIZE; // 860
      const photoH = PHOTO_DRAW_SIZE; // square

      // Save + rotate slightly & draw
      if (photo) {
        const tiltAngle = 0.02;
        ctx.save();
        ctx.translate(photoX + photoW / 2, photoY + photoH / 2);
        ctx.rotate(tiltAngle);
        // draw the photo centered with square size
        ctx.drawImage(photo, -photoW / 2, -photoH / 2, photoW, photoH);
        ctx.restore();
      }

      // Name text
      const name = document.getElementById('name').value || "";
      ctx.save();
      ctx.translate(145, 1262);
      ctx.rotate(0.02);
      ctx.fillStyle = nameFontColor;
      ctx.font = "bold 48px Futura, Arial";
      ctx.textBaseline = "alphabetic";
      // fallback if font width measurement needed
      ctx.fillText(name, 0, 0);
      ctx.restore();

      // Course text
      const course = document.getElementById('course').value || "";
      ctx.save();
      ctx.translate(145, 1327);
      ctx.rotate(0.02);
      ctx.fillStyle = courseFontColor;
      ctx.font = "bold 32px Futura, Arial";
      ctx.fillText(course, 0, 0);
      ctx.restore();
    }

    // download final PNG
    function generateCard() {
      const nameVal = (document.getElementById('name').value || 'Graduation').trim() || 'Graduation';
      const filename = nameVal.replace(/\s+/g, '') + ".png";
      const canvas = document.getElementById('cardCanvas');
      const link = document.createElement('a');
      link.download = filename;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    // initial draw
    drawCard();

    // safety: hide modal click outside
    cropModal.addEventListener('click', (e) => {
      if (e.target === cropModal) {
        // same as cancel
        if (cropper) { try { cropper.destroy(); } catch(e){} cropper = null; }
        cropModal.classList.remove('visible');
        document.body.style.overflow = '';
        photoInput.value = "";
      }
    });
  </script>
</body>
</html>
